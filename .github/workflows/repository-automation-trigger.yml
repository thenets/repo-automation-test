---
name: "Repository Automation: Trigger"
# Simplified trigger workflow - creates minimal artifact and triggers workflow_run event

on:
  issues:
    types: [opened, labeled, unlabeled]
  pull_request:
    types: [opened, synchronize, edited, ready_for_review, labeled, unlabeled]

# No special permissions required - this runs on forks with default GITHUB_TOKEN
permissions:
  contents: read

jobs:
  trigger:
    runs-on: ubuntu-latest
    
    steps:
      - name: Create Minimal Metadata
        run: |
          echo "ğŸš€ Creating minimal metadata for workflow_run event"
          echo "Event: ${{ github.event_name }}.${{ github.event.action }}"
          echo "Number: ${{ github.event.pull_request.number || github.event.issue.number }}"
          echo "Repository: ${{ github.repository }}"
          
          mkdir -p ./pr-metadata
          if [ "${{ github.event_name }}" == "pull_request" ]; then
            # Create base64 encoded metadata to prevent JSON parsing issues with special characters
            TITLE_B64=$(echo -n '${{ github.event.pull_request.title }}' | base64 -w 0)
            BODY_B64=$(echo -n '${{ github.event.pull_request.body }}' | base64 -w 0)
            
            cat > ./pr-metadata/metadata.json << EOF
          {
            "type": "pull_request",
            "event_action": "${{ github.event.action }}",
            "number": ${{ github.event.pull_request.number }},
            "title_base64": "$TITLE_B64",
            "body_base64": "$BODY_B64",
            "state": "${{ github.event.pull_request.state }}",
            "encoding": {
              "title": "base64",
              "body": "base64"
            },
            "head": {
              "ref": "${{ github.event.pull_request.head.ref }}",
              "sha": "${{ github.event.pull_request.head.sha }}"
            },
            "base": {
              "ref": "${{ github.event.pull_request.base.ref }}",
              "sha": "${{ github.event.pull_request.base.sha }}"
            },
            "author": {
              "login": "${{ github.event.pull_request.user.login }}",
              "id": ${{ github.event.pull_request.user.id }}
            }
          }
          EOF
          elif [ "${{ github.event_name }}" == "issues" ]; then
            # Create base64 encoded metadata to prevent JSON parsing issues with special characters
            TITLE_B64=$(echo -n '${{ github.event.issue.title }}' | base64 -w 0)
            BODY_B64=$(echo -n '${{ github.event.issue.body }}' | base64 -w 0)
            
            cat > ./pr-metadata/metadata.json << EOF
          {
            "type": "issue",
            "event_action": "${{ github.event.action }}",
            "number": ${{ github.event.issue.number }},
            "title_base64": "$TITLE_B64",
            "body_base64": "$BODY_B64",
            "state": "${{ github.event.issue.state }}",
            "encoding": {
              "title": "base64",
              "body": "base64"
            },
            "author": {
              "login": "${{ github.event.issue.user.login }}",
              "id": ${{ github.event.issue.user.id }}
            }
          }
          EOF
          fi
          
          echo "âœ… Minimal metadata created"

      - name: Store Metadata as Artifact
        uses: actions/upload-artifact@v4
        with:
          name: pr-metadata
          path: pr-metadata/metadata.json
          retention-days: 1